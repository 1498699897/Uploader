/*!
 * Uploader - Uploader library implements html5 file upload and provides multiple simultaneous, stable, fault tolerant and resumable uploads
 * @version v0.0.1
 * @author dolymood <dolymood@gmail.com>
 * @link https://github.com/dolymood/Uploader
 * @license MIT
 */
!function(t){if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.Uploader=t()}}(function(){return function t(e,i,s){function n(a,h){if(!i[a]){if(!e[a]){var o="function"==typeof require&&require;if(!h&&o)return o(a,!0);if(r)return r(a,!0);throw new Error("Cannot find module '"+a+"'")}var u=i[a]={exports:{}};e[a][0].call(u.exports,function(t){var i=e[a][1][t];return n(i||t)},u,u.exports,t,e,i,s)}return i[a].exports}for(var r="function"==typeof require&&require,a=0;a<s.length;a++)n(s[a]);return n}({1:[function(t,e,i){function s(t,e,i){this.uploader=t,this.file=e,this.bytes=null,this.offset=i,this.tested=!1,this.retries=0,this.pendingRetry=!1,this.preprocessState=0,this.readState=0,this.loaded=0,this.total=0,this.chunkSize=this.uploader.opts.chunkSize,this.startByte=this.offset*this.chunkSize,this.endByte=Math.min(this.file.size,(this.offset+1)*this.chunkSize),this.xhr=null}var n=t("./utils"),r=s.STATUS={PENDING:"pending",UPLOADING:"uploading",READING:"reading",SUCCESS:"success",ERROR:"error",COMPLETE:"complete",PROGRESS:"progress",RETRY:"retry"};n.extend(s.prototype,{_event:function(t,e){(e=n.toArray(arguments)).unshift(this),this.file._chunkEvent.apply(this.file,e)},getParams:function(){return{chunkNumber:this.offset+1,chunkSize:this.uploader.opts.chunkSize,currentChunkSize:this.endByte-this.startByte,totalSize:this.file.size,identifier:this.file.uniqueIdentifier,filename:this.file.name,relativePath:this.file.relativePath,totalChunks:this.file.chunks.length}},getTarget:function(t,e){return t.indexOf("?")<0?t+="?":t+="&",t+e.join("&")},test:function(){function t(t){var e=s.status(!0);e===r.ERROR?(s._event(e,s.message()),s.uploader.uploadNextChunk()):e===r.SUCCESS?(s.tested=!0,s._event(e,s.message()),s.uploader.uploadNextChunk()):s.file.paused||(s.tested=!0,s.send())}this.xhr=new XMLHttpRequest,this.xhr.addEventListener("load",t,!1),this.xhr.addEventListener("error",t,!1);var e=n.evalOpts(this.uploader.opts.testMethod,this.file,this),i=this.prepareXhrRequest(e,!0);this.xhr.send(i);var s=this},preprocessFinished:function(){this.endByte=Math.min(this.file.size,(this.offset+1)*this.chunkSize),this.file.size-this.endByte<this.chunkSize&&!this.uploader.opts.forceChunkSize&&(this.endByte=this.file.size),this.preprocessState=2,this.send()},readFinished:function(t){this.readState=2,this.bytes=t,this.send()},send:function(){function t(t){var e=h.status();if(e===r.SUCCESS||e===r.ERROR)delete this.data,h._event(e,h.message()),h.uploader.uploadNextChunk();else{h._event(r.RETRY,h.message()),h.pendingRetry=!0,h.abort(),h.retries++;var i=h.uploader.opts.chunkRetryInterval;null!==i?setTimeout(function(){h.send()},i):h.send()}}var e=this.uploader.opts.preprocess,i=this.uploader.opts.readFileFn;if(n.isFunction(e))switch(this.preprocessState){case 0:return this.preprocessState=1,void e(this);case 1:return}switch(this.readState){case 0:return this.readState=1,void i(this.file,this.file.fileType,this.startByte,this.endByte,this);case 1:return}if(!this.uploader.opts.testChunks||this.tested){this.loaded=0,this.total=0,this.pendingRetry=!1,this.xhr=new XMLHttpRequest,this.xhr.upload.addEventListener("progress",function(t){t.lengthComputable&&(h.loaded=t.loaded,h.total=t.total),h._event(r.PROGRESS,t)},!1),this.xhr.addEventListener("load",t,!1),this.xhr.addEventListener("error",t,!1);var s=n.evalOpts(this.uploader.opts.uploadMethod,this.file,this),a=this.prepareXhrRequest(s,!1,this.uploader.opts.method,this.bytes);this.xhr.send(a);var h=this}else this.test()},abort:function(){var t=this.xhr;this.xhr=null,t&&t.abort()},status:function(t){return 1===this.readState?r.READING:this.pendingRetry||1===this.preprocessState?r.UPLOADING:this.xhr?this.xhr.readyState<4?r.UPLOADING:this.uploader.opts.successStatuses.indexOf(this.xhr.status)>-1?r.SUCCESS:this.uploader.opts.permanentErrors.indexOf(this.xhr.status)>-1||!t&&this.retries>=this.uploader.opts.maxChunkRetries?r.ERROR:(this.abort(),r.PENDING):r.PENDING},message:function(){return this.xhr?this.xhr.responseText:""},progress:function(){if(this.pendingRetry)return 0;var t=this.status();return t===r.SUCCESS||t===r.ERROR?1:t===r.PENDING?0:this.total>0?this.loaded/this.total:0},sizeUploaded:function(){var t=this.endByte-this.startByte;return this.status()!==r.SUCCESS&&(t=this.progress()*t),t},prepareXhrRequest:function(t,e,i,s){var r=n.evalOpts(this.uploader.opts.query,this.file,this,e);r=n.extend(this.getParams(),r);var a=n.evalOpts(this.uploader.opts.target,this.file,this,e),h=null;if("GET"===t||"octet"===i){var o=[];n.each(r,function(t,e){o.push([encodeURIComponent(e),encodeURIComponent(t)].join("="))}),a=this.getTarget(a,o),h=s||null}else h=new FormData,n.each(r,function(t,e){h.append(e,t)}),h.append(this.uploader.opts.fileParameterName,s,this.file.name);return this.xhr.open(t,a,!0),this.xhr.withCredentials=this.uploader.opts.withCredentials,n.each(n.evalOpts(this.uploader.opts.headers,this.file,this,e),function(t,e){this.xhr.setRequestHeader(e,t)},this),h}}),e.exports=s},{"./utils":5}],2:[function(t,e,i){var s=t("./utils").each,n={_eventData:null,on:function(t,e){this._eventData||(this._eventData={}),this._eventData[t]||(this._eventData[t]=[]);var i=!1;s(this._eventData[t],function(t){if(t===e)return i=!0,!1}),i||this._eventData[t].push(e)},off:function(t,e){this._eventData||(this._eventData={}),this._eventData[t]&&this._eventData[t].length&&(e?s(this._eventData[t],function(i,s){if(i===e)return this._eventData[t].splice(s,1),!1},this):this._eventData[t]=[])},trigger:function(t){if(this._eventData||(this._eventData={}),!this._eventData[t])return!0;var e=this._eventData[t].slice.call(arguments,1),i=!1;return s(this._eventData[t],function(t){i=!1===t.apply(this,e)||i},this),!i}};e.exports=n},{"./utils":5}],3:[function(t,e,i){function s(t){this.support=u,this.support&&!o&&(this.supportDirectory=l,this.filePaths={},this.opts=n.extend(s.defaults,t||{}),a.call(this,this))}var n=t("./utils"),r=t("./event"),a=t("./file"),h=t("./chunk"),o=window.navigator.msPointerEnabled,u=function(){var t="slice",e=n.isDefined(window.File)&&n.isDefined(window.Blob)&&n.isDefined(window.FileList),i=null;return e&&(i=window.Blob.prototype,n.each(["slice","webkitSlice","mozSlice"],function(e){if(i[e])return t=e,!1}),e=!!i[t]),e&&(s.sliceName=t),i=null,e}(),l=function(){var t=window.document.createElement("input");t.type="file";var e="webkitdirectory"in t||"directory"in t;return t=null,e}();s.version="0.0.1",s.defaults={chunkSize:1048576,forceChunkSize:!1,simultaneousUploads:3,singleFile:!1,fileParameterName:"file",progressCallbacksInterval:500,speedSmoothingFactor:.1,query:{},headers:{},withCredentials:!1,preprocess:null,method:"multipart",testMethod:"GET",uploadMethod:"POST",prioritizeFirstAndLastChunk:!1,allowDuplicateUploads:!1,target:"/",testChunks:!0,generateUniqueIdentifier:null,maxChunkRetries:0,chunkRetryInterval:null,permanentErrors:[404,415,500,501],successStatuses:[200,201,202],onDropStopPropagation:!1,initFileFn:null,readFileFn:function(t,e,i,s,n){var r="slice";t.file.slice?r="slice":t.file.mozSlice?r="mozSlice":t.file.webkitSlice&&(r="webkitSlice"),n.readFinished(t.file[r](i,s,e))}},s.utils=n,s.event=r,s.File=a,s.Chunk=h,s.prototype=n.extend({},a.prototype),n.extend(s.prototype,r),n.extend(s.prototype,{constructor:s,_trigger:function(t){var e=n.toArray(arguments,1),i=!this.trigger.apply(this,arguments);return"catchAll"!==t&&(e.unshift("catchAll"),i=!this.trigger.apply(this,e)||i),!i},_triggerAsync:function(){var t=arguments;n.nextTick(function(){this._trigger.apply(this,t)},this)},onDrop:function(t){this.opts.onDropStopPropagation&&t.stopPropagation(),t.preventDefault();var e=t.dataTransfer;e.items&&e.items[0]&&e.items[0].webkitGetAsEntry?this.webkitReadDataTransfer(t):this.addFiles(e.files,t)},webkitReadDataTransfer:function(t){function e(t){t.readEntries(function(a){a.length?(h+=a.length,n.each(a,function(t){if(t.isFile){var n=t.fullPath;t.file(function(t){i(t,n)},s)}else t.isDirectory&&e(t.createReader())}),e(t)):r()},s)}function i(t,e){t.relativePath=e.substring(1),o.push(t),r()}function s(t){throw t}function r(){0==--h&&a.addFiles(o,t)}var a=this,h=t.dataTransfer.items.length,o=[];n.each(t.dataTransfer.items,function(t){var s=t.webkitGetAsEntry();s?s.isFile?i(t.getAsFile(),s.fullPath):e(s.createReader()):r()})},addFiles:function(t,e){var i=[],s=this.fileList.length;if(n.each(t,function(t){if((!o||o&&t.size>0)&&(t.size%4096!=0||"."!==t.name&&"."!==t.fileName)&&(this.opts.allowDuplicateUploads||!this.getFromUniqueIdentifier(this.generateUniqueIdentifier(t)))){var s=new a(this,t,this);this._trigger("fileAdded",s,e)&&i.push(s)}},this),i.length){var r=this.fileList.slice(s);this._trigger("filesAdded",i,r,e)&&n.each(i,function(t){this.opts.singleFile&&this.files.length>0&&this.removeFile(this.files[0]),this.files.push(t)},this),this._trigger("filesSubmitted",i,r,e)}},addFile:function(t,e){this.addFiles([t],e)},generateUniqueIdentifier:function(t){var e=this.opts.generateUniqueIdentifier;if(n.isFunction("function"===e))return e(t);var i=t.relativePath||t.webkitRelativePath||t.fileName||t.name;return t.size+"-"+i.replace(/[^0-9a-zA-Z_-]/gim,"")},getFromUniqueIdentifier:function(t){var e=!1;return n.each(this.files,function(i){if(i.uniqueIdentifier===t)return e=i,!1}),e},uploadNextChunk:function(t){var e=!1,i=h.STATUS.PENDING;if(this.opts.prioritizeFirstAndLastChunk&&(n.each(this.files,function(t){return!t.paused&&t.chunks.length&&t.chunks[0].status()===i?(t.chunks[0].send(),e=!0,!1):!t.paused&&t.chunks.length>1&&t.chunks[t.chunks.length-1].status()===i?(t.chunks[t.chunks.length-1].send(),e=!0,!1):void 0}),e))return e;if(n.each(this.files,function(t){if(t.paused||n.each(t.chunks,function(t){if(t.status()===i)return t.send(),e=!0,!1}),e)return!1}),e)return!0;var s=!1;return n.each(this.files,function(t){if(!t.isComplete())return s=!0,!1}),s||t||this._triggerAsync("complete"),!1},upload:function(){var t=this._shouldUploadNext();if(!1!==t){this._trigger("uploadStart");for(var e=!1,i=1;i<=this.opts.simultaneousUploads-t;i++)e=this.uploadNextChunk(!0)||e;e||this._triggerAsync("complete")}},_shouldUploadNext:function(){var t=0,e=!0,i=this.opts.simultaneousUploads,s=h.STATUS.UPLOADING;return n.each(this.files,function(r){r.isComplete()||n.each(r.chunks,function(n){if(n.status()===s&&++t>=i)return e=!1,!1})}),e&&t},assignBrowse:function(t,e,i,s){void 0===t.length&&(t=[t]),n.each(t,function(t){var r;"INPUT"===t.tagName&&"file"===t.type?r=t:((r=document.createElement("input")).setAttribute("type","file"),n.extend(r.style,{visibility:"hidden",position:"absolute",width:"1px",height:"1px"}),t.appendChild(r),t.addEventListener("click",function(){r.click()},!1)),this.opts.singleFile||i||r.setAttribute("multiple","multiple"),e&&r.setAttribute("webkitdirectory","webkitdirectory"),s&&n.each(s,function(t,e){r.setAttribute(e,t)});var a=this;r.addEventListener("change",function(t){t.target.value&&(a.addFiles(t.target.files,t),t.target.value="")},!1)},this)},assignDrop:function(t){void 0===t.length&&(t=[t]),this._onDrop=n.bind(this.onDrop,this),n.each(t,function(t){t.addEventListener("dragover",n.preventEvent,!1),t.addEventListener("dragenter",n.preventEvent,!1),t.addEventListener("drop",this._onDrop,!1)},this)},unAssignDrop:function(t){void 0===t.length&&(t=[t]),n.each(t,function(t){t.removeEventListener("dragover",n.preventEvent,!1),t.removeEventListener("dragenter",n.preventEvent,!1),t.removeEventListener("drop",this._onDrop,!1),this._onDrop=null},this)}}),e.exports=s},{"./chunk":1,"./event":2,"./file":4,"./utils":5}],4:[function(t,e,i){function s(t,e,i){this.uploader=t,this.isRoot=this.isFolder=t===this,this.parent=i||null,this.files=[],this.fileList=[],this.chunks=[],this.isRoot||!e?this.file=null:r.isString(e)?(this.isFolder=!0,this.path=e,this.parent.path&&(e=e.substr(this.parent.path.length)),this.name="/"===e.charAt(e.length-1)?e.substr(0,e.length-1):e):(this.file=e,this.fileType=this.file.type,this.name=e.fileName||e.name,this.size=e.size,this.relativePath=e.relativePath||e.webkitRelativePath||this.name,this.uniqueIdentifier=t.generateUniqueIdentifier(e),this._parseFile()),this.started=!1,this.paused=!1,this.error=!1,this.averageSpeed=0,this.currentSpeed=0,this._lastProgressCallback=Date.now(),this._prevUploadedSize=0,this._prevProgress=0,this.bootstrap()}function n(t){var e=[],i=t.split("/"),s=i.length,n=1;if(i.splice(s-1,1),s--,i.length)for(;n<=s;)e.push(i.slice(0,n++).join("/")+"/");return e}var r=t("./utils"),a=t("./chunk");r.extend(s.prototype,{_parseFile:function(){var t=n(this.relativePath);if(t.length){var e=this.uploader.filePaths;r.each(t,function(i,n){var r=e[i];r||(r=new s(this.uploader,i,this.parent),e[i]=r,this._updateParentFileList(r)),this.parent=r,t[n+1]||(r.files.push(this),r.fileList.push(this))},this)}else this._updateParentFileList()},_updateParentFileList:function(t){t||(t=this);var e=this.parent;if(e)for(e.fileList.push(t);e&&!e.isRoot;)e.files.push(this),e=e.parent},_eachAccess:function(t,e){this.isFolder?r.each(this.files,function(e,i){return t.call(this,e,i)},this):(e||(e=t),e.call(this,this))},bootstrap:function(){if(!this.isFolder){var t=this.uploader.opts;r.isFunction(t.initFileFn)&&t.initFileFn.call(this,this),this.abort(!0),this.error=!1,this._prevProgress=0;for(var e=t.forceChunkSize?Math.ceil:Math.floor,i=Math.max(e(this.size/t.chunkSize),1),s=0;s<i;s++)this.chunks.push(new a(this.uploader,this,s))}},_measureSpeed:function(){var t=Date.now()-this._lastProgressCallback;if(t){var e=this.uploader.opts.speedSmoothingFactor,i=this.sizeUploaded();this.currentSpeed=Math.max((i-this._prevUploadedSize)/t*1e3,0),this.averageSpeed=e*this.currentSpeed+(1-e)*this.averageSpeed,this._prevUploadedSize=i}},_chunkEvent:function(t,e,i){var s=this.uploader,n=a.STATUS;switch(e){case n.PROGRESS:if(Date.now()-this._lastProgressCallback<s.opts.progressCallbacksInterval)break;this._measureSpeed(),s._trigger("fileProgress",this,t),s._trigger("progress"),this._lastProgressCallback=Date.now();break;case n.ERROR:this.error=!0,this.abort(!0),s._trigger("fileError",this,i,t),s._trigger("error",i,this,t);break;case n.SUCCESS:if(this.error)return;this._measureSpeed(),s._trigger("fileProgress",this,t),s._trigger("progress"),this._lastProgressCallback=Date.now(),this.isComplete()&&(this.currentSpeed=0,this.averageSpeed=0,s._trigger("fileSuccess",this,i,t));break;case n.RETRY:s._trigger("fileRetry",this,t)}},isComplete:function(){var t=!1;return this._eachAccess(function(e){if(!e.isComplete())return t=!0,!1},function(){var e=a.STATUS;r.each(this.chunks,function(i){var s=i.status();if(s===e.PENDING||s===e.UPLOADING||s===e.READING||1===i.preprocessState||1===i.readState)return t=!0,!1})}),!t},isUploading:function(){var t=!1;return this._eachAccess(function(e){if(e.isUploading())return t=!0,!1},function(){var e=a.STATUS.UPLOADING;r.each(this.chunks,function(i){if(i.status()===e)return t=!0,!1})}),t},resume:function(){this._eachAccess(function(t){t.resume()},function(){this.paused=!1,this.uploader.upload()})},pause:function(){this._eachAccess(function(t){t.pause()},function(){this.paused=!0,this.abort()})},cancel:function(){if(this.isFolder)for(var t=this.files.length-1;t>=0;t--)this.files[t].cancel();else this.uploader.removeFile(this)},retry:function(t){t?t.bootstrap():this._eachAccess(function(t){t.bootstrap()},function(){this.file.bootstrap()}),this.uploader.upload()},abort:function(t){this.currentSpeed=0,this.averageSpeed=0;var e=this.chunks;t&&(this.chunks=[]);var i=a.STATUS.UPLOADING;r.each(e,function(t){t.status()===i&&(t.abort(),this.uploader.uploadNextChunk())},this)},progress:function(){var t,e=0,i=0;return this._eachAccess(function(s,n){e+=s.progress()*s.size,i+=s.size,n===this.files.length-1&&(t=i>0?e/i:this.isComplete()?1:0)},function(){if(this.error)t=1;else{if(1===this.chunks.length)return this._prevProgress=Math.max(this._prevProgress,this.chunks[0].progress()),void(t=this._prevProgress);var e=0;r.each(this.chunks,function(t){e+=t.progress()*(t.endByte-t.startByte)});var i=e/this.size;this._prevProgress=Math.max(this._prevProgress,i>.9999?1:i),t=this._prevProgress}}),t},getSize:function(){var t=0;return this._eachAccess(function(e){t+=e.size},function(){t+=this.size}),t},getFormatSize:function(){var t=this.getSize();return t<1024?t+" bytes":t<1048576?(t/1024).toFixed(0)+" KB":t<1073741824?(t/1024/1024).toFixed(1)+" MB":(t/1024/1024/1024).toFixed(1)+" GB"},sizeUploaded:function(){var t=0;return this._eachAccess(function(e){t+=e.sizeUploaded()},function(){r.each(this.chunks,function(e){t+=e.sizeUploaded()})}),t},timeRemaining:function(){function t(t,e){return t&&!e?Number.POSITIVE_INFINITY:t||e?Math.floor(t/e):0}var e,i=0,s=0;return this._eachAccess(function(n,r){n.paused||n.error||(i+=n.size-n.sizeUploaded(),s+=n.averageSpeed),r===this.files.length-1&&(e=t(i,s))},function(){if(this.paused||this.error)e=0;else{var i=this.size-this.sizeUploaded();e=t(i,this.averageSpeed)}}),e},removeFile:function(t){if(t.isFolder)return t.parent&&t.parent._removeFile(t),void r.each(t.files,function(t){this.removeFile(t)},this);r.each(this.files,function(e,i){if(e===t)return this.files.splice(i,1),t.abort(),t.parent&&t.parent._removeFile(t),!1},this)},_removeFile:function(t){!t.isFolder&&r.each(this.files,function(e,i){if(e===t)return this.files.splice(i,1),this.parent&&this.parent._removeFile(t),!1},this),t.parent===this&&r.each(this.fileList,function(e,i){if(e===t)return this.fileList.splice(i,1),!1},this)},getType:function(){return this.isFolder?"Folder":this.file.type&&this.file.type.split("/")[1]},getExtension:function(){return this.isFolder?"":this.name.substr(2+(~-this.name.lastIndexOf(".")>>>0)).toLowerCase()}}),e.exports=s},{"./chunk":1,"./utils":5}],5:[function(t,e,i){var s=Object.prototype,n=Array.prototype,r=s.toString,a=function(t){return"[object Function]"===r.call(t)},h=Array.isArray||function(t){return"[object Array]"===r.call(t)},o=function(t){return"[object Object]"===r.call(t)&&Object.getPrototypeOf(t)===s},u={noop:function(){},bind:function(t,e){return function(){return t.apply(e,arguments)}},preventEvent:function(t){t.preventDefault()},stop:function(t){t.preventDefault(),t.stopPropagation()},nextTick:function(t,e){setTimeout(u.bind(t,e),0)},toArray:function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=t.length),n.slice.call(t,e,i)},isPlainObject:o,isFunction:a,isArray:h,isObject:function(t){return Object(t)===t},isString:function(t){return"string"==typeof t},isUndefined:function(t){return void 0===t},isDefined:function(t){return void 0!==t},each:function(t,e,i){if(u.isDefined(t.length))for(var s=0,n=t.length;s<n&&!1!==e.call(i,t[s],s,t);s++);else for(var r in t)if(!1===e.call(i,t[r],r,t))break},evalOpts:function(t,e){return u.isFunction(t)&&(e=u.toArray(arguments),t=t.apply(null,e.slice(1))),t},extend:function(){var t,e,i,s,n,r,l=arguments[0]||{},c=1,f=arguments.length,p=!1;for("boolean"==typeof l&&(p=l,l=arguments[1]||{},c++),"object"==typeof l||a(l)||(l={}),c===f&&(l=this,c--);c<f;c++)if(null!=(t=arguments[c]))for(e in t)i=l[e],l!==(s=t[e])&&(p&&s&&(o(s)||(n=h(s)))?(n?(n=!1,r=i&&h(i)?i:[]):r=i&&o(i)?i:{},l[e]=u.extend(p,r,s)):void 0!==s&&(l[e]=s));return l}};e.exports=u},{}]},{},[3])(3)});
//# sourceMappingURL=uploader.min.js.map
